<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      libmosquitto学习 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="HeartJ Jiang">
    
    

    <meta name="description" content="mosquitto模块分析概述libmosquitto 作为 mosquitto 开源代码的一部分，主要用来实现 MQTT 协议栈和数据包通讯功能。
下面将对libmosquitto包含的 mosquitto 模块进行分析。  

mosquitto.hmosquitto.h中定义了外部调用的接口，利用mosquitto进行开发时，需要包含mosquitto.h文件。 包含下列内容：  

枚举值">
<meta property="og:type" content="website">
<meta property="og:title" content="libmosquitto学习">
<meta property="og:url" content="http://mycreation.tech/mosquitto/libmosquittoLearn.html">
<meta property="og:site_name" content="My Software">
<meta property="og:description" content="mosquitto模块分析概述libmosquitto 作为 mosquitto 开源代码的一部分，主要用来实现 MQTT 协议栈和数据包通讯功能。
下面将对libmosquitto包含的 mosquitto 模块进行分析。  

mosquitto.hmosquitto.h中定义了外部调用的接口，利用mosquitto进行开发时，需要包含mosquitto.h文件。 包含下列内容：  

枚举值">
<meta property="og:updated_time" content="2016-11-04T14:57:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="libmosquitto学习">
<meta name="twitter:description" content="mosquitto模块分析概述libmosquitto 作为 mosquitto 开源代码的一部分，主要用来实现 MQTT 协议栈和数据包通讯功能。
下面将对libmosquitto包含的 mosquitto 模块进行分析。  

mosquitto.hmosquitto.h中定义了外部调用的接口，利用mosquitto进行开发时，需要包含mosquitto.h文件。 包含下列内容：  

枚举值">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css" type="text/css">
    <link rel="stylesheet" href="/css/highlight.css" type="text/css">
    <link rel="stylesheet" href="/css/archive.css" type="text/css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">My Software</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/" title="" class="">首页</a></li>
              
                
                <li class="navigation__item"><a href="/DraftNote" title="" class="">Draftnote</a></li>
              
                
                <li class="navigation__item"><a href="/reminder" title="" class="">Reminder</a></li>
              
                
                <li class="navigation__item"><a href="/mosquitto" title="" class="">mosquitto</a></li>
              
                
                <li class="navigation__item"><a href="/blah" title="" class="">碎碎念</a></li>
              
                
                <li class="navigation__item"><a href="/tech" title="" class="">Tech</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">libmosquitto学习</h1>

    

  </header>

  <section id="post-content" class="article-content post">
    <h1 id="mosquitto模块分析">mosquitto模块分析</h1><h1 id="概述">概述</h1><p><strong>libmosquitto</strong> 作为 <strong>mosquitto</strong> 开源代码的一部分，主要用来实现 <strong>MQTT</strong> 协议栈和数据包通讯功能。</p>
<p>下面将对<strong>libmosquitto</strong>包含的 <strong>mosquitto</strong> 模块进行分析。  </p>
<hr>
<h1 id="mosquitto-h">mosquitto.h</h1><p><strong>mosquitto.h</strong>中定义了外部调用的接口，利用<strong>mosquitto</strong>进行开发时，需要包含<strong>mosquitto.h</strong>文件。 包含下列内容：  </p>
<ul>
<li>枚举值</li>
<li>宏定义</li>
<li>头文件包含</li>
<li>struct结构体</li>
<li>对外接口</li>
</ul>
<h3 id="1、mosquitto_message">1、mosquitto_message</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> mosquitto_message&#123;</span><br><span class="line">	<span class="keyword">int</span> mid;</span><br><span class="line">	<span class="keyword">char</span> *topic;</span><br><span class="line">	<span class="keyword">void</span> *payload;</span><br><span class="line">	<span class="keyword">int</span> payloadlen;</span><br><span class="line">	<span class="keyword">int</span> qos;</span><br><span class="line">	<span class="keyword">bool</span> retain;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>消息结构</p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mid</td>
<td>消息id</td>
<td></td>
</tr>
<tr>
<td>topic</td>
<td>话题名称</td>
<td></td>
</tr>
<tr>
<td>payload</td>
<td>负载内容</td>
<td></td>
</tr>
<tr>
<td>payloadlen</td>
<td>负载长度</td>
<td></td>
</tr>
<tr>
<td>qos</td>
<td>服务质量，value=0，1，2</td>
</tr>
<tr>
<td>retain</td>
<td>是否保留，value=0，1</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="3、mosquitto_lib_version（版本接口）">3、mosquitto_lib_version（版本接口）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_lib_version</span><span class="params">(<span class="keyword">int</span> *major, <span class="keyword">int</span> *minor, <span class="keyword">int</span> *revision)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(major) *major = LIBMOSQUITTO_MAJOR;</span><br><span class="line">	<span class="keyword">if</span>(minor) *minor = LIBMOSQUITTO_MINOR;</span><br><span class="line">	<span class="keyword">if</span>(revision) *revision = LIBMOSQUITTO_REVISION;</span><br><span class="line">	<span class="keyword">return</span> LIBMOSQUITTO_VERSION_NUMBER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回版本号</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>decription</th>
</tr>
</thead>
<tbody>
<tr>
<td>major</td>
<td>如果不为NULL，赋值为major version</td>
<td></td>
</tr>
<tr>
<td>minor</td>
<td>如果不为NULL，赋值为ninor version</td>
<td></td>
</tr>
<tr>
<td>revision</td>
<td>如果不为NULL，赋值为revision version</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td>int,返回完整的版本号</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="4、mosquitto_lib_init（初始化）">4、mosquitto_lib_init（初始化）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_lib_init</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">	srand(GetTickCount());</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">struct</span> timeval tv;</span><br><span class="line"></span><br><span class="line">	gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">	srand(tv.tv_sec*<span class="number">1000</span> + tv.tv_usec/<span class="number">1000</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	_mosquitto_net_init();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>该方法必须在所有<strong>mosquitto方法</strong>之前调用，相当于初始化<strong>mosquitto</strong>使用环境</li>
<li>该方法不是<strong>线程安全</strong>的</li>
<li>始终返回<strong>MOSQ_ERR_SUCCESS</strong></li>
</ul>
<h3 id="5、mosquitto_lib_cleanup（资源回收）">5、mosquitto_lib_cleanup（资源回收）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_lib_cleanup</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	_mosquitto_net_cleanup();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放分配的资源</li>
<li>始终返回<strong>MOSQ_ERR_SUCCESS</strong></li>
</ul>
<h3 id="6、mosquitto_new（创建客户端实例）">6、mosquitto_new（创建客户端实例）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">struct</span> mosquitto *<span class="title">mosquitto_new</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id, <span class="keyword">bool</span> clean_session, <span class="keyword">void</span> *userdata)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> mosquitto *mosq = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(clean_session == <span class="literal">false</span> &amp;&amp; id == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		errno = EINVAL;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> WIN32</span></span><br><span class="line">	signal(SIGPIPE, SIG_IGN);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	mosq = (<span class="keyword">struct</span> mosquitto *)_mosquitto_calloc(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mosquitto));</span><br><span class="line">	<span class="keyword">if</span>(mosq)&#123;</span><br><span class="line">		mosq-&gt;sock = INVALID_SOCKET;</span><br><span class="line">		mosq-&gt;sockpairR = INVALID_SOCKET;</span><br><span class="line">		mosq-&gt;sockpairW = INVALID_SOCKET;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_THREADING</span></span><br><span class="line">		mosq-&gt;thread_id = pthread_self();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		rc = mosquitto_reinitialise(mosq, id, clean_session, userdata);</span><br><span class="line">		<span class="keyword">if</span>(rc)&#123;</span><br><span class="line">			mosquitto_destroy(mosq);</span><br><span class="line">			<span class="keyword">if</span>(rc == MOSQ_ERR_INVAL)&#123;</span><br><span class="line">				errno = EINVAL;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(rc == MOSQ_ERR_NOMEM)&#123;</span><br><span class="line">				errno = ENOMEM;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		errno = ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> mosq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个新的客户端实例</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>客户端id。如果为NULL，会生成一个随机id。如果为NULL，clean_session必须为 true</td>
<td></td>
</tr>
<tr>
<td>clean_session</td>
<td>如果为true，通知broker在断开连接时清除所有的消息及订阅；如果为false，则通知broker在断开连接时保留消息及订阅。需要注意，客户端在断开时应该永远不丢弃所持有的输出消息</td>
<td></td>
</tr>
<tr>
<td>userdata</td>
<td>用户指针，传递给回调函数的变量</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回一个mosquitto结构体；<br>内存溢出，ENOMEM；<br>无效的变量，返回EINVAL，</td>
</tr>
</tbody>
</table>
<h3 id="7、mosquitto_destroy（销毁客户端实例）">7、mosquitto_destroy（销毁客户端实例）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mosquitto_destroy</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	_mosquitto_destroy(mosq);</span><br><span class="line">	_mosquitto_free(mosq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放客户端实例</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>要释放的实例</td>
</tr>
</tbody>
</table>
<h3 id="8、mosquitto_reinitialise（重新初始化）">8、mosquitto_reinitialise（重新初始化）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_reinitialise</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *id, <span class="keyword">bool</span> clean_session, <span class="keyword">void</span> *userdata)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(clean_session == <span class="literal">false</span> &amp;&amp; id == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_mosquitto_destroy(mosq);</span><br><span class="line">	<span class="built_in">memset</span>(mosq, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mosquitto));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(userdata)&#123;</span><br><span class="line">		mosq-&gt;userdata = userdata;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mosq-&gt;userdata = mosq;</span><br><span class="line">	&#125;</span><br><span class="line">	mosq-&gt;protocol = mosq_p_mqtt31;</span><br><span class="line">	mosq-&gt;sock = INVALID_SOCKET;</span><br><span class="line">	mosq-&gt;sockpairR = INVALID_SOCKET;</span><br><span class="line">	mosq-&gt;sockpairW = INVALID_SOCKET;</span><br><span class="line">	mosq-&gt;keepalive = <span class="number">60</span>;</span><br><span class="line">	mosq-&gt;message_retry = <span class="number">20</span>;</span><br><span class="line">	mosq-&gt;last_retry_check = <span class="number">0</span>;</span><br><span class="line">	mosq-&gt;clean_session = clean_session;</span><br><span class="line">	<span class="keyword">if</span>(id)&#123;</span><br><span class="line">		<span class="keyword">if</span>(STREMPTY(id))&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		mosq-&gt;id = _mosquitto_strdup(id);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mosq-&gt;id = (<span class="keyword">char</span> *)_mosquitto_calloc(<span class="number">24</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;id)&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		mosq-&gt;id[<span class="number">0</span>] = <span class="string">'m'</span>;</span><br><span class="line">		mosq-&gt;id[<span class="number">1</span>] = <span class="string">'o'</span>;</span><br><span class="line">		mosq-&gt;id[<span class="number">2</span>] = <span class="string">'s'</span>;</span><br><span class="line">		mosq-&gt;id[<span class="number">3</span>] = <span class="string">'q'</span>;</span><br><span class="line">		mosq-&gt;id[<span class="number">4</span>] = <span class="string">'/'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">5</span>; i&lt;<span class="number">23</span>; i++)&#123;</span><br><span class="line">			mosq-&gt;id[i] = (rand()%<span class="number">73</span>)+<span class="number">48</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mosq-&gt;in_packet.payload = <span class="literal">NULL</span>;</span><br><span class="line">	_mosquitto_packet_cleanup(&amp;mosq-&gt;in_packet);</span><br><span class="line">	mosq-&gt;out_packet = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;current_out_packet = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;last_msg_in = mosquitto_time();</span><br><span class="line">	mosq-&gt;last_msg_out = mosquitto_time();</span><br><span class="line">	mosq-&gt;<span class="keyword">ping_t</span> = <span class="number">0</span>;</span><br><span class="line">	mosq-&gt;last_mid = <span class="number">0</span>;</span><br><span class="line">	mosq-&gt;state = mosq_cs_new;</span><br><span class="line">	mosq-&gt;in_messages = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;in_messages_last = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;out_messages = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;out_messages_last = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;max_inflight_messages = <span class="number">20</span>;</span><br><span class="line">	mosq-&gt;will = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;on_connect = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;on_publish = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;on_message = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;on_subscribe = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;on_unsubscribe = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;host = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;port = <span class="number">1883</span>;</span><br><span class="line">	mosq-&gt;in_callback = <span class="literal">false</span>;</span><br><span class="line">	mosq-&gt;in_queue_len = <span class="number">0</span>;</span><br><span class="line">	mosq-&gt;out_queue_len = <span class="number">0</span>;</span><br><span class="line">	mosq-&gt;reconnect_delay = <span class="number">1</span>;</span><br><span class="line">	mosq-&gt;reconnect_delay_max = <span class="number">1</span>;</span><br><span class="line">	mosq-&gt;reconnect_exponential_backoff = <span class="literal">false</span>;</span><br><span class="line">	mosq-&gt;threaded = <span class="literal">false</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_TLS</span></span><br><span class="line">	mosq-&gt;ssl = <span class="literal">NULL</span>;</span><br><span class="line">	mosq-&gt;tls_cert_reqs = SSL_VERIFY_PEER;</span><br><span class="line">	mosq-&gt;tls_insecure = <span class="literal">false</span>;</span><br><span class="line">	mosq-&gt;want_write = <span class="literal">false</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_THREADING</span></span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;callback_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;log_callback_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;state_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;out_packet_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;current_out_packet_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;msgtime_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;in_message_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;out_message_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_mutex_init(&amp;mosq-&gt;mid_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	mosq-&gt;thread_id = pthread_self();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>复用已有的客户端实例，关闭当前客户端的连接，释放内存，使用新的参数来创建客户端实例，相当于用<strong>mosquitto_new</strong>方法重新的创建一个实例</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>id</td>
<td>参考 mosquitto_new方法</td>
</tr>
<tr>
<td>clean_session</td>
<td>参考 mosquitto_new方法</td>
</tr>
<tr>
<td>obj</td>
<td>参考 mosquitto_new方法</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>内存溢出，返回MOSQ_ERR_NOMEM</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="9、mosquitto_will_set（设置will）">9、mosquitto_will_set（设置will）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_will_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *topic, <span class="keyword">int</span> payloadlen, <span class="keyword">const</span> <span class="keyword">void</span> *payload, <span class="keyword">int</span> qos, <span class="keyword">bool</span> retain)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">return</span> _mosquitto_will_set(mosq, topic, payloadlen, payload, qos, retain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>为客户端设置will。默认情况，客户端没有will，必须在<strong>mosquitto_connect</strong> 之前调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
</tr>
<tr>
<td>topic</td>
<td>发布will的话题</td>
</tr>
<tr>
<td>payloadlen</td>
<td>载荷长度，长度在0-268,435,455之间</td>
</tr>
<tr>
<td>payload</td>
<td>载荷，如果payloadlen长度大于0，则必须指向一块有效的内存</td>
</tr>
<tr>
<td>qos</td>
<td>用于will的服务质量，value=0，1，2</td>
</tr>
<tr>
<td>retain</td>
<td>true，令will是一个要保留的消息（？待确定）</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>输入参数无效，返回MOSQ_ERR_INVAL；<br>内存溢出，返回MOSQ_ERR_NOMEM；<br>payloadlen过大，返回MOSQ_ERR_PAYLOAD_SIZE</td>
</tr>
</tbody>
</table>
<h3 id="10、mosquitto_will_clear（清除will）">10、mosquitto_will_clear（清除will）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_will_clear</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">return</span> _mosquitto_will_clear(mosq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>清除设置的will，必须在<strong>mosquitto_connect</strong>之前调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<h3 id="11、mosquitto_username_pw_set（用户名、密码设置）">11、mosquitto_username_pw_set（用户名、密码设置）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_username_pw_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *username, <span class="keyword">const</span> <span class="keyword">char</span> *password)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;username)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;username);</span><br><span class="line">		mosq-&gt;username = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;password)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;password);</span><br><span class="line">		mosq-&gt;password = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(username)&#123;</span><br><span class="line">		mosq-&gt;username = _mosquitto_strdup(username);</span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;username) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		<span class="keyword">if</span>(password)&#123;</span><br><span class="line">			mosq-&gt;password = _mosquitto_strdup(password);</span><br><span class="line">			<span class="keyword">if</span>(!mosq-&gt;password)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;username);</span><br><span class="line">				mosq-&gt;username = <span class="literal">NULL</span>;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>为一个客户端实例配置用户名和密码，仅在broker实现MQTT V3.1协议时使用。默认情况下，不会发送用户名和密码。必须在<strong>mosquitto_connect</strong>之前调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
</tr>
<tr>
<td>username</td>
<td>字符串形式的用户名，如果为空，则忽略password，关闭身份验证</td>
</tr>
<tr>
<td>password</td>
<td>字符串形式的密码，当置为NULL，并且用户名有效时，仅发送用户名</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>内存溢出，返回MOSQ_ERR_NOMEM</td>
</tr>
</tbody>
</table>
<h3 id="12、mosquitto_connect（连接）">12、mosquitto_connect（连接）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_connect</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> port, <span class="keyword">int</span> keepalive)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mosquitto_connect_bind(mosq, host, port, keepalive, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到broker</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>host</td>
<td>broker的主机名或者ip地址</td>
</tr>
<tr>
<td>port</td>
<td>broker的网络端口，通常为1883</td>
</tr>
<tr>
<td>keepalive</td>
<td>当没有数据交互时，broker发送PING message的时间间隔</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="13、mosquitto_connect_bind（连接（扩展））">13、mosquitto_connect_bind（连接（扩展））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_connect_bind</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> port, <span class="keyword">int</span> keepalive, <span class="keyword">const</span> <span class="keyword">char</span> *bind_address)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	rc = _mosquitto_connect_init(mosq, host, port, keepalive, bind_address);</span><br><span class="line">	<span class="keyword">if</span>(rc) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">	mosq-&gt;state = mosq_cs_new;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> _mosquitto_reconnect(mosq, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到broker，通过添加(bind <em> address)变量扩展了<em>_mosquitto_connect</em></em>函数。当需要通过特殊的接口来限制网络连接时，使用此函数。</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>host</td>
<td>broker的主机名或者ip地址</td>
</tr>
<tr>
<td>port</td>
<td>broker的网络端口，通常为1883</td>
</tr>
<tr>
<td>keepalive</td>
<td>当没有数据交互时，broker发送PING message的时间间隔</td>
</tr>
<tr>
<td>bind_address</td>
<td>本地网络提供绑定的主机名或ip地址</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="14、mosquitto_connect_async（异步连接）">14、mosquitto_connect_async（异步连接）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_connect_async</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> port, <span class="keyword">int</span> keepalive)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mosquitto_connect_bind_async(mosq, host, port, keepalive, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>非阻塞形式连接broker，如果通过异步方式连接broker，客户端必须使用<strong>mosquitto_loop_start</strong>。如果要是用<strong>mosquitto_loop</strong>，则必须使用<strong>mosquitto_connect</strong></li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>host</td>
<td>broker的主机名或者ip地址</td>
</tr>
<tr>
<td>port</td>
<td>broker的网络端口，通常为1883</td>
</tr>
<tr>
<td>keepalive</td>
<td>当没有数据交互时，broker发送PING message的时间间隔</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="15、mosquitto_connect_bind_async（异步连接（扩展））">15、mosquitto_connect_bind_async（异步连接（扩展））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_connect_bind_async</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> port, <span class="keyword">int</span> keepalive, <span class="keyword">const</span> <span class="keyword">char</span> *bind_address)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc = _mosquitto_connect_init(mosq, host, port, keepalive, bind_address);</span><br><span class="line">	<span class="keyword">if</span>(rc) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">	mosq-&gt;state = mosq_cs_connect_async;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> _mosquitto_reconnect(mosq, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>非阻塞形式连接broker，如果通过异步方式连接broker，客户端必须使用<strong>mosquitto_loop_start</strong>。如果要是用<strong>mosquitto_loop</strong>，则必须使用<strong>mosquitto_connect</strong></li>
<li>通过添加(bind <em> address)变量扩展了<em>_mosquitto_connect_async</em></em>函数。当需要通过特殊的接口来限制网络连接时，使用此函数</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>host</td>
<td>broker的主机名或者ip地址</td>
</tr>
<tr>
<td>port</td>
<td>broker的网络端口，通常为1883</td>
</tr>
<tr>
<td>keepalive</td>
<td>当没有数据交互时，broker发送PING message的时间间隔</td>
</tr>
<tr>
<td>bind_address</td>
<td>本地网络提供绑定的主机名或ip地址</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="16、mosquitto_reconnect（重新连接）">16、mosquitto_reconnect（重新连接）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_reconnect</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> _mosquitto_reconnect(mosq, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重新连接broker</li>
<li>提供了一种简单的方式在连接断开后重新连接broker的函数，使用在<strong>mosquitto_connect</strong>中提供的参数进行连接，不允许在<strong>mosquitto_connect</strong>之前调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="17、mosquitto_reconnect_async（异步重新连接）">17、mosquitto_reconnect_async（异步重新连接）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_reconnect_async</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> _mosquitto_reconnect(mosq, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>异步方式重新连接broker</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="18、mosquitto_disconnect（断开连接）">18、mosquitto_disconnect（断开连接）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_disconnect</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">	mosq-&gt;state = mosq_cs_disconnecting;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;sock == INVALID_SOCKET) <span class="keyword">return</span> MOSQ_ERR_NO_CONN;</span><br><span class="line">	<span class="keyword">return</span> _mosquitto_send_disconnect(mosq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>断开与broker的连接</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS；<br>参数无效，返回MOSQ_ERR_INVAL；<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="19、mosquitto_publish（发布消息）">19、mosquitto_publish（发布消息）</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">int mosquitto_publish(struct mosquitto *mosq, int *mid, const char *topic, int payloadlen, const void *payload, int qos, bool retain)</span><br><span class="line">&#123;</span><br><span class="line">	struct mosquitto_message_all *message;</span><br><span class="line">	uint16_t local_mid;</span><br><span class="line">	int queue_status;</span><br><span class="line"></span><br><span class="line">	if(!mosq || !topic || qos&lt;0 || qos&gt;2) return MOSQ_ERR_INVAL;</span><br><span class="line">	if(STREMPTY(topic)) return MOSQ_ERR_INVAL;</span><br><span class="line">	if(payloadlen &lt; 0 || payloadlen &gt; MQTT_MAX_PAYLOAD) return MOSQ_ERR_PAYLOAD_SIZE;</span><br><span class="line"></span><br><span class="line">	if(mosquitto_pub_topic_check(topic) != MOSQ_ERR_SUCCESS)&#123;</span><br><span class="line">		return MOSQ_ERR_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	local_mid = _mosquitto_mid_generate(mosq);</span><br><span class="line">	if(mid)&#123;</span><br><span class="line">		*mid = local_mid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if(qos == 0)&#123;</span><br><span class="line">		return _mosquitto_send_publish(mosq, local_mid, topic, payloadlen, payload, qos, retain, false);</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		message = _mosquitto_calloc(1, sizeof(struct mosquitto_message_all));</span><br><span class="line">		if(!message) return MOSQ_ERR_NOMEM;</span><br><span class="line"></span><br><span class="line">		message-&gt;next = NULL;</span><br><span class="line">		message-&gt;timestamp = mosquitto_time();</span><br><span class="line">		message-&gt;msg.mid = local_mid;</span><br><span class="line">		message-&gt;msg.topic = _mosquitto_strdup(topic);</span><br><span class="line">		if(!message-&gt;msg.topic)&#123;</span><br><span class="line">			_mosquitto_message_cleanup(&amp;message);</span><br><span class="line">			return MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		if(payloadlen)&#123;</span><br><span class="line">			message-&gt;msg.payloadlen = payloadlen;</span><br><span class="line">			message-&gt;msg.payload = _mosquitto_malloc(payloadlen*sizeof(uint8_t));</span><br><span class="line">			if(!message-&gt;msg.payload)&#123;</span><br><span class="line">				_mosquitto_message_cleanup(&amp;message);</span><br><span class="line">				return MOSQ_ERR_NOMEM;</span><br><span class="line">			&#125;</span><br><span class="line">			memcpy(message-&gt;msg.payload, payload, payloadlen*sizeof(uint8_t));</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			message-&gt;msg.payloadlen = 0;</span><br><span class="line">			message-&gt;msg.payload = NULL;</span><br><span class="line">		&#125;</span><br><span class="line">		message-&gt;msg.qos = qos;</span><br><span class="line">		message-&gt;msg.retain = retain;</span><br><span class="line">		message-&gt;dup = false;</span><br><span class="line"></span><br><span class="line">		pthread_mutex_lock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line">		queue_status = _mosquitto_message_queue(mosq, message, mosq_md_out);</span><br><span class="line">		if(queue_status == 0)&#123;</span><br><span class="line">			if(qos == 1)&#123;</span><br><span class="line">				message-&gt;state = mosq_ms_wait_for_puback;</span><br><span class="line">			&#125;else if(qos == 2)&#123;</span><br><span class="line">				message-&gt;state = mosq_ms_wait_for_pubrec;</span><br><span class="line">			&#125;</span><br><span class="line">			pthread_mutex_unlock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line">			return _mosquitto_send_publish(mosq, message-&gt;msg.mid, message-&gt;msg.topic, message-&gt;msg.payloadlen, message-&gt;msg.payload, message-&gt;msg.qos, message-&gt;msg.retain, message-&gt;dup);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			message-&gt;state = mosq_ms_invalid;</span><br><span class="line">			pthread_mutex_unlock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line">			return MOSQ_ERR_SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在给定topic上发布消息</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>mid</td>
<td>int指针。<br>如果为NULL，函数将其设定给消息的message id。<br>可以与消息发布后的回调函数一起使用<br>需要注意，虽然MQTT协议没有在QoS=0的消息中使用message id，但libmosquitto为这些消息指定了message id，通过这些参数可以跟踪消息</td>
</tr>
<tr>
<td>topic</td>
<td>发布消息的topic</td>
</tr>
<tr>
<td>payloadlen</td>
<td>载荷长度，长度在0-268,435,455之间</td>
</tr>
<tr>
<td>payload</td>
<td>载荷，如果payloadlen长度大于0，则必须指向一块有效的内存</td>
</tr>
<tr>
<td>qos</td>
<td>用服务质量，value=0，1，2</td>
</tr>
<tr>
<td>retain</td>
<td>true，保留消息（？待确定）</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS <br>参数无效，返回MOSQ_ERR_INVAL <br>内存溢出，MOSQ_ERR_NOMEM <br>客户端并没有连接到broker，返回MOSQ_ERR_NO_CONN <br>与broker的通信中协议错误，返回MOSQ_ERR_PROTOCOL <br>payloadlen过大，返回MOSQ_ERR_PAYLOAD_SIZE</td>
</tr>
</tbody>
</table>
<h3 id="20、mosquitto_subscribe（订阅消息）">20、mosquitto_subscribe（订阅消息）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_subscribe</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosqq, <span class="keyword">int</span> *mid, <span class="keyword">const</span> <span class="keyword">char</span> *sub, <span class="keyword">int</span> qos)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosqq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">if</span>(mosqq-&gt;sock == INVALID_SOCKET) <span class="keyword">return</span> MOSQ_ERR_NO_CONN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosquitto_sub_topic_check(sub)) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> _mosquitto_send_subscribe(mosqq, mid, sub, qos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>订阅一个topic</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosqq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>mid</td>
<td>int指针。<br>如果为NULL，函数将其设定给消息的message id。<br>可以与消息发布后的回调函数一起使用<br>需要注意，虽然MQTT协议没有在QoS=0的消息中使用message id，但libmosquitto为这些消息指定了message id，通过这些参数可以跟踪消息</td>
</tr>
<tr>
<td>topic</td>
<td>发布消息的topic</td>
</tr>
<tr>
<td>sub</td>
<td>订阅模式</td>
</tr>
<tr>
<td>qos</td>
<td>订阅要求的服务质量</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS <br>参数无效，返回MOSQ_ERR_INVAL <br>内存溢出，MOSQ_ERR_NOMEM <br>客户端并没有连接到broker，返回MOSQ_ERR_NO_CONN </td>
</tr>
</tbody>
</table>
<h3 id="21、mosquitto_unsubscribe（取消订阅）">21、mosquitto_unsubscribe（取消订阅）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_unsubscribe</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">int</span> *mid, <span class="keyword">const</span> <span class="keyword">char</span> *sub)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;sock == INVALID_SOCKET) <span class="keyword">return</span> MOSQ_ERR_NO_CONN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosquitto_sub_topic_check(sub)) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> _mosquitto_send_unsubscribe(mosq, mid, sub);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>取消订阅</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>一个有效的客户端实例</td>
<td></td>
</tr>
<tr>
<td>mid</td>
<td>int指针。<br>如果为NULL，函数将其设定给消息的message id。<br>可以与取消订阅后的回调函数一起使用<br>需要注意，虽然MQTT协议没有在QoS=0的消息中使用message id，但libmosquitto为这些消息指定了message id，通过这些参数可以跟踪消息</td>
<td></td>
</tr>
<tr>
<td>sub</td>
<td>取消定于的模式</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS <br>参数无效，返回MOSQ_ERR_INVAL <br>内存溢出，MOSQ_ERR_NOMEM <br>客户端并没有连接到broker，返回MOSQ_ERR_NO_CONN</td>
</tr>
</tbody>
</table>
<h3 id="22、mosquitto_message_copy（消息拷贝(在message_mosq-c中实现)）">22、mosquitto_message_copy（消息拷贝(在message_mosq.c中实现)）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_message_copy</span><span class="params">(<span class="keyword">struct</span> mosquitto_message *dst, <span class="keyword">const</span> <span class="keyword">struct</span> mosquitto_message *src)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!dst || !src) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	dst-&gt;mid = src-&gt;mid;</span><br><span class="line">	dst-&gt;topic = _mosquitto_strdup(src-&gt;topic);</span><br><span class="line">	<span class="keyword">if</span>(!dst-&gt;topic) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	dst-&gt;qos = src-&gt;qos;</span><br><span class="line">	dst-&gt;retain = src-&gt;retain;</span><br><span class="line">	<span class="keyword">if</span>(src-&gt;payloadlen)&#123;</span><br><span class="line">		dst-&gt;payload = _mosquitto_malloc(src-&gt;payloadlen);</span><br><span class="line">		<span class="keyword">if</span>(!dst-&gt;payload)&#123;</span><br><span class="line">			_mosquitto_free(dst-&gt;topic);</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memcpy</span>(dst-&gt;payload, src-&gt;payload, src-&gt;payloadlen);</span><br><span class="line">		dst-&gt;payloadlen = src-&gt;payloadlen;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		dst-&gt;payloadlen = <span class="number">0</span>;</span><br><span class="line">		dst-&gt;payload = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>拷贝一条消息内容到另一条消息中。可以用于在 <strong>on_message()</strong> 回调中保持消息。</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>dst</td>
<td>目的消息</td>
</tr>
<tr>
<td>src</td>
<td>源消息</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS <br>参数无效，返回MOSQ_ERR_INVAL <br>内存溢出，MOSQ_ERR_NOMEM</td>
</tr>
</tbody>
</table>
<h3 id="23、mosquitto_message_free（释放消息(在message_mosq-c中实现)）">23、mosquitto_message_free（释放消息(在message_mosq.c中实现)）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mosquitto_message_free</span><span class="params">(<span class="keyword">struct</span> mosquitto_message **message)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> mosquitto_message *msg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!message || !*message) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	msg = *message;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(msg-&gt;topic) _mosquitto_free(msg-&gt;topic);</span><br><span class="line">	<span class="keyword">if</span>(msg-&gt;payload) _mosquitto_free(msg-&gt;payload);</span><br><span class="line">	_mosquitto_free(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放一条mosquitto_message消息</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>message</td>
<td>指向一条待释放的消息</td>
</tr>
</tbody>
</table>
<h3 id="24、mosquitto_loop（启动循环）">24、mosquitto_loop（启动循环）</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">int mosquitto_loop(struct mosquitto *mosq, int timeout, int max_packets)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef HAVE_PSELECT</span><br><span class="line">	struct timespec local_timeout;</span><br><span class="line">#else</span><br><span class="line">	struct timeval local_timeout;</span><br><span class="line">#endif</span><br><span class="line">	fd_set readfds, writefds;</span><br><span class="line">	int fdcount;</span><br><span class="line">	int rc;</span><br><span class="line">	char pairbuf;</span><br><span class="line">	int maxfd = 0;</span><br><span class="line"></span><br><span class="line">	if(!mosq || max_packets &lt; 1) return MOSQ_ERR_INVAL;</span><br><span class="line">#ifndef WIN32</span><br><span class="line">	if(mosq-&gt;sock &gt;= FD_SETSIZE || mosq-&gt;sockpairR &gt;= FD_SETSIZE)&#123;</span><br><span class="line">		return MOSQ_ERR_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	FD_ZERO(&amp;readfds);</span><br><span class="line">	FD_ZERO(&amp;writefds);</span><br><span class="line">	if(mosq-&gt;sock != INVALID_SOCKET)&#123;</span><br><span class="line">		maxfd = mosq-&gt;sock;</span><br><span class="line">		FD_SET(mosq-&gt;sock, &amp;readfds);</span><br><span class="line">		pthread_mutex_lock(&amp;mosq-&gt;current_out_packet_mutex);</span><br><span class="line">		pthread_mutex_lock(&amp;mosq-&gt;out_packet_mutex);</span><br><span class="line">		if(mosq-&gt;out_packet || mosq-&gt;current_out_packet)&#123;</span><br><span class="line">			FD_SET(mosq-&gt;sock, &amp;writefds);</span><br><span class="line">		&#125;</span><br><span class="line">#ifdef WITH_TLS</span><br><span class="line">		if(mosq-&gt;ssl)&#123;</span><br><span class="line">			if(mosq-&gt;want_write)&#123;</span><br><span class="line">				FD_SET(mosq-&gt;sock, &amp;writefds);</span><br><span class="line">			&#125;else if(mosq-&gt;want_connect)&#123;</span><br><span class="line">				/* Remove possible FD_SET from above, we don't want to check</span><br><span class="line">				 * for writing if we are still connecting, unless want_write is</span><br><span class="line">				 * definitely set. The presence of outgoing packets does not</span><br><span class="line">				 * matter yet. */</span><br><span class="line">				FD_CLR(mosq-&gt;sock, &amp;writefds);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">#endif</span><br><span class="line">		pthread_mutex_unlock(&amp;mosq-&gt;out_packet_mutex);</span><br><span class="line">		pthread_mutex_unlock(&amp;mosq-&gt;current_out_packet_mutex);</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">#ifdef WITH_SRV</span><br><span class="line">		if(mosq-&gt;achan)&#123;</span><br><span class="line">			pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">			if(mosq-&gt;state == mosq_cs_connect_srv)&#123;</span><br><span class="line">				rc = ares_fds(mosq-&gt;achan, &amp;readfds, &amp;writefds);</span><br><span class="line">				if(rc &gt; maxfd)&#123;</span><br><span class="line">					maxfd = rc;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">				pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">				return MOSQ_ERR_NO_CONN;</span><br><span class="line">			&#125;</span><br><span class="line">			pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">		&#125;</span><br><span class="line">#else</span><br><span class="line">		return MOSQ_ERR_NO_CONN;</span><br><span class="line">#endif</span><br><span class="line">	&#125;</span><br><span class="line">	if(mosq-&gt;sockpairR != INVALID_SOCKET)&#123;</span><br><span class="line">		/* sockpairR is used to break out of select() before the timeout, on a</span><br><span class="line">		 * call to publish() etc. */</span><br><span class="line">		FD_SET(mosq-&gt;sockpairR, &amp;readfds);</span><br><span class="line">		if(mosq-&gt;sockpairR &gt; maxfd)&#123;</span><br><span class="line">			maxfd = mosq-&gt;sockpairR;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if(timeout &gt;= 0)&#123;</span><br><span class="line">		local_timeout.tv_sec = timeout/1000;</span><br><span class="line">#ifdef HAVE_PSELECT</span><br><span class="line">		local_timeout.tv_nsec = (timeout-local_timeout.tv_sec*1000)*1e6;</span><br><span class="line">#else</span><br><span class="line">		local_timeout.tv_usec = (timeout-local_timeout.tv_sec*1000)*1000;</span><br><span class="line">#endif</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		local_timeout.tv_sec = 1;</span><br><span class="line">#ifdef HAVE_PSELECT</span><br><span class="line">		local_timeout.tv_nsec = 0;</span><br><span class="line">#else</span><br><span class="line">		local_timeout.tv_usec = 0;</span><br><span class="line">#endif</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">#ifdef HAVE_PSELECT</span><br><span class="line">	fdcount = pselect(maxfd+1, &amp;readfds, &amp;writefds, NULL, &amp;local_timeout, NULL);</span><br><span class="line">#else</span><br><span class="line">	fdcount = select(maxfd+1, &amp;readfds, &amp;writefds, NULL, &amp;local_timeout);</span><br><span class="line">#endif</span><br><span class="line">	if(fdcount == -1)&#123;</span><br><span class="line">#ifdef WIN32</span><br><span class="line">		errno = WSAGetLastError();</span><br><span class="line">#endif</span><br><span class="line">		if(errno == EINTR)&#123;</span><br><span class="line">			return MOSQ_ERR_SUCCESS;</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			return MOSQ_ERR_ERRNO;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		if(mosq-&gt;sock != INVALID_SOCKET)&#123;</span><br><span class="line">			if(FD_ISSET(mosq-&gt;sock, &amp;readfds))&#123;</span><br><span class="line">#ifdef WITH_TLS</span><br><span class="line">				if(mosq-&gt;want_connect)&#123;</span><br><span class="line">					rc = mosquitto__socket_connect_tls(mosq);</span><br><span class="line">					if(rc) return rc;</span><br><span class="line">				&#125;else</span><br><span class="line">#endif</span><br><span class="line">				&#123;</span><br><span class="line">					do&#123;</span><br><span class="line">						rc = mosquitto_loop_read(mosq, max_packets);</span><br><span class="line">						if(rc || mosq-&gt;sock == INVALID_SOCKET)&#123;</span><br><span class="line">							return rc;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;while(SSL_DATA_PENDING(mosq));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(mosq-&gt;sockpairR != INVALID_SOCKET &amp;&amp; FD_ISSET(mosq-&gt;sockpairR, &amp;readfds))&#123;</span><br><span class="line">#ifndef WIN32</span><br><span class="line">				if(read(mosq-&gt;sockpairR, &amp;pairbuf, 1) == 0)&#123;</span><br><span class="line">				&#125;</span><br><span class="line">#else</span><br><span class="line">				recv(mosq-&gt;sockpairR, &amp;pairbuf, 1, 0);</span><br><span class="line">#endif</span><br><span class="line">				/* Fake write possible, to stimulate output write even though</span><br><span class="line">				 * we didn't ask for it, because at that point the publish or</span><br><span class="line">				 * other command wasn't present. */</span><br><span class="line">				FD_SET(mosq-&gt;sock, &amp;writefds);</span><br><span class="line">			&#125;</span><br><span class="line">			if(FD_ISSET(mosq-&gt;sock, &amp;writefds))&#123;</span><br><span class="line">#ifdef WITH_TLS</span><br><span class="line">				if(mosq-&gt;want_connect)&#123;</span><br><span class="line">					rc = mosquitto__socket_connect_tls(mosq);</span><br><span class="line">					if(rc) return rc;</span><br><span class="line">				&#125;else</span><br><span class="line">#endif</span><br><span class="line">				&#123;</span><br><span class="line">					rc = mosquitto_loop_write(mosq, max_packets);</span><br><span class="line">					if(rc || mosq-&gt;sock == INVALID_SOCKET)&#123;</span><br><span class="line">						return rc;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">#ifdef WITH_SRV</span><br><span class="line">		if(mosq-&gt;achan)&#123;</span><br><span class="line">			ares_process(mosq-&gt;achan, &amp;readfds, &amp;writefds);</span><br><span class="line">		&#125;</span><br><span class="line">#endif</span><br><span class="line">	&#125;</span><br><span class="line">	return mosquitto_loop_misc(mosq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端的网络工作主循环。必须周期性的调用此函数来保证客户端和broker之间的通信。如果流入数据已经就绪，将会被处理。通常会在调用发布消息时立刻将消息发出。此函数会尝试发送任何已经保留的输出消息，包括一部分用于QoS&gt;0的消息流中的命令（？待确定）</li>
<li>可以在客户端所拥有的线程中开启循环，使用的方法是<strong>mosquitto_loop_start</strong></li>
<li>此方法使用select方式进行轮询监控socket，如果想要整合mosquitto客户端和自己的select方法，可以使用<strong>mosquitto_socket</strong>，<strong>mosquitto_loop_read</strong>，<strong>mosquitto_loop_write</strong>和<strong>mosquitto_loop_misc</strong></li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>timeout</td>
<td>select的超时时间，如果为0，则立刻调用，默认为<strong>1000毫秒</strong></td>
</tr>
<tr>
<td>max_packets</td>
<td>未使用，为了兼容性应该设置为<strong>1</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS<br>参数无效，返回MOSQ_ERR_INVAL<br>内存溢出，返回MOSQ_ERR_NOMEM<br>与broker未连接，返回MOSQ_ERR_NO_CONN<br>连接失效，返回MOSQ_ERR_CONN_LOST<br>与broker通信中，协议错误，返回MOSQ_ERR_PROTOCOL<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="25、mosquitto_loop_forever（启动循环（永久））">25、mosquitto_loop_forever（启动循环（永久））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_forever</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">int</span> timeout, <span class="keyword">int</span> max_packets)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> run = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> reconnects = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> reconnect_delay;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;state == mosq_cs_connect_async)&#123;</span><br><span class="line">		mosquitto_reconnect(mosq);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(run)&#123;</span><br><span class="line">		<span class="keyword">do</span>&#123;</span><br><span class="line">			rc = mosquitto_loop(mosq, timeout, max_packets);</span><br><span class="line">			<span class="keyword">if</span> (reconnects !=<span class="number">0</span> &amp;&amp; rc == MOSQ_ERR_SUCCESS)&#123;</span><br><span class="line">				reconnects = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">while</span>(run &amp;&amp; rc == MOSQ_ERR_SUCCESS);</span><br><span class="line">		<span class="comment">/* Quit after fatal errors. */</span></span><br><span class="line">		<span class="keyword">switch</span>(rc)&#123;</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_NOMEM:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_PROTOCOL:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_INVAL:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_NOT_FOUND:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_TLS:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_PAYLOAD_SIZE:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_NOT_SUPPORTED:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_AUTH:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_ACL_DENIED:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_UNKNOWN:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_EAI:</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_PROXY:</span><br><span class="line">				<span class="keyword">return</span> rc;</span><br><span class="line">			<span class="keyword">case</span> MOSQ_ERR_ERRNO:</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(errno == EPROTO)&#123;</span><br><span class="line">			<span class="keyword">return</span> rc;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">do</span>&#123;</span><br><span class="line">			rc = MOSQ_ERR_SUCCESS;</span><br><span class="line">			pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">			<span class="keyword">if</span>(mosq-&gt;state == mosq_cs_disconnecting)&#123;</span><br><span class="line">				run = <span class="number">0</span>;</span><br><span class="line">				pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span>(mosq-&gt;reconnect_delay &gt; <span class="number">0</span> &amp;&amp; mosq-&gt;reconnect_exponential_backoff)&#123;</span><br><span class="line">					reconnect_delay = mosq-&gt;reconnect_delay*reconnects*reconnects;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					reconnect_delay = mosq-&gt;reconnect_delay;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span>(reconnect_delay &gt; mosq-&gt;reconnect_delay_max)&#123;</span><br><span class="line">					reconnect_delay = mosq-&gt;reconnect_delay_max;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					reconnects++;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">				Sleep(reconnect_delay*<span class="number">1000</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">				sleep(reconnect_delay);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">				pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">				<span class="keyword">if</span>(mosq-&gt;state == mosq_cs_disconnecting)&#123;</span><br><span class="line">					run = <span class="number">0</span>;</span><br><span class="line">					pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">					rc = mosquitto_reconnect(mosq);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">while</span>(run &amp;&amp; rc != MOSQ_ERR_SUCCESS);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当在程序中，仅仅需要启动MQTT客户端时，可以使用此方法。启动一个永久阻塞的循环</li>
<li>当连接失效时，会重新连接，调用<strong>mosquitto_disconnect()</strong>可以结束并返回</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>timeout</td>
<td>select的超时时间，如果为0，则立刻调用，默认为<strong>1000毫秒</strong></td>
</tr>
<tr>
<td>max_packets</td>
<td>未使用，为了兼容性应该设置为<strong>1</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS<br>参数无效，返回MOSQ_ERR_INVAL<br>内存溢出，返回MOSQ_ERR_NOMEM<br>与broker未连接，返回MOSQ_ERR_NO_CONN<br>连接失效，返回MOSQ_ERR_CONN_LOST<br>与broker通信中，协议错误，返回MOSQ_ERR_PROTOCOL<br>系统调用失败，返回MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="26、mosquitto_loop_start（启动循环（线程，在thread_mosq-c中实现））">26、mosquitto_loop_start（启动循环（线程，在thread_mosq.c中实现））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_start</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_THREADING</span></span><br><span class="line">	<span class="keyword">if</span>(!mosq || mosq-&gt;threaded) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;threaded = <span class="literal">true</span>;</span><br><span class="line">	pthread_create(&amp;mosq-&gt;thread_id, <span class="literal">NULL</span>, _mosquitto_thread_main, mosq);</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>每调用一次此函数，将开启一个新的线程去处理网络业务。为用户提供一种重复调用<strong>mosquitto_loop</strong>的替代方法</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS<br>参数无效，返回MOSQ_ERR_INVAL<br>线程不支持，返回MOSQ_ERR_NOT_SUPPORTED</td>
</tr>
</tbody>
</table>
<h3 id="27、mosquitto_loop_stop（停止循环（在thread_mosq-c中实现））">27、mosquitto_loop_stop（停止循环（在thread_mosq.c中实现））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_stop</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">bool</span> force)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_THREADING</span></span><br><span class="line"><span class="preprocessor">#  <span class="keyword">ifndef</span> WITH_BROKER</span></span><br><span class="line">	<span class="keyword">char</span> sockpair_data = <span class="number">0</span>;</span><br><span class="line"><span class="preprocessor">#  <span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!mosq || !mosq-&gt;threaded) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write a single byte to sockpairW (connected to sockpairR) to break out</span><br><span class="line">	 * of select() if in threaded mode. */</span></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;sockpairW != INVALID_SOCKET)&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> WIN32</span></span><br><span class="line">		<span class="keyword">if</span>(write(mosq-&gt;sockpairW, &amp;sockpair_data, <span class="number">1</span>))&#123;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		send(mosq-&gt;sockpairW, &amp;sockpair_data, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(force)&#123;</span><br><span class="line">		pthread_cancel(mosq-&gt;thread_id);</span><br><span class="line">	&#125;</span><br><span class="line">	pthread_join(mosq-&gt;thread_id, <span class="literal">NULL</span>);</span><br><span class="line">	mosq-&gt;thread_id = pthread_self();</span><br><span class="line">	mosq-&gt;threaded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>停止使用<strong>mosquitto_loop_start</strong> 启动的的网络线程。这个函数会阻塞，直到网络线程停止。为了是网络线程终止，必须先调用<strong>mosquitto_disconnect</strong>或者将参数<strong>force</strong>设置为<strong>true</strong></li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>force</td>
<td>true，强行结束线程<br>false，必须先调用<strong>mosquitto_disconnect</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS<br>参数无效，返回MOSQ_ERR_INVAL<br>线程不支持，返回MOSQ_ERR_NOT_SUPPORTED</td>
</tr>
</tbody>
</table>
<h3 id="28、mosquitto_socket">28、mosquitto_socket</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_socket</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">	<span class="keyword">return</span> mosq-&gt;sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回一个mosquitto实例的socket句柄。如果希望在select调用中包含一个mosquitto实例的话，这个方法很有用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回socket<br>失败，返回-1</td>
</tr>
</tbody>
</table>
<h3 id="29、mosquitto_loop_read（循环：读）">29、mosquitto_loop_read（循环：读）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_read</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">int</span> max_packets)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>(max_packets &lt; <span class="number">1</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line">	max_packets = mosq-&gt;out_queue_len;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;in_message_mutex);</span><br><span class="line">	max_packets += mosq-&gt;in_queue_len;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;in_message_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(max_packets &lt; <span class="number">1</span>) max_packets = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* Queue len here tells us how many messages are awaiting processing and</span><br><span class="line">	 * have QoS &gt; 0. We should try to deal with that many in this loop in order</span><br><span class="line">	 * to keep up. */</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;max_packets; i++)&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_SOCKS</span></span><br><span class="line">		<span class="keyword">if</span>(mosq-&gt;socks5_host)&#123;</span><br><span class="line">			rc = mosquitto__socks5_read(mosq);</span><br><span class="line">		&#125;<span class="keyword">else</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		&#123;</span><br><span class="line">			rc = _mosquitto_packet_read(mosq);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(rc || errno == EAGAIN || errno == COMPAT_EWOULDBLOCK)&#123;</span><br><span class="line">			<span class="keyword">return</span> _mosquitto_loop_rc_handle(mosq, rc);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行网络读的动作</li>
<li>仅仅用于不使用<strong>mosquitto_loop()</strong>，并且自己监控客户端socket时</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>max_packets</td>
<td>未使用，为了兼容性应该设置为<strong>1</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>参数无效，返回 MOSQ_ERR_INVAL<br>内存溢出，返回 MOSQ_ERR_NOMEM<br>客户端没有连接broker，返回 MOSQ_ERR_NO_CONN<br>与broker的连接失效，返回 MOSQ_ERR_CONN_LOST<br>与broker的通信中，协议错误，返回 MOSQ_ERR_PROTOCOL<br>系统调用失败，返回 MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="30、mosquitto_loop_write（循环：写）">30、mosquitto_loop_write（循环：写）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_write</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">int</span> max_packets)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>(max_packets &lt; <span class="number">1</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line">	max_packets = mosq-&gt;out_queue_len;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;out_message_mutex);</span><br><span class="line"></span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;in_message_mutex);</span><br><span class="line">	max_packets += mosq-&gt;in_queue_len;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;in_message_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(max_packets &lt; <span class="number">1</span>) max_packets = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">/* Queue len here tells us how many messages are awaiting processing and</span><br><span class="line">	 * have QoS &gt; 0. We should try to deal with that many in this loop in order</span><br><span class="line">	 * to keep up. */</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;max_packets; i++)&#123;</span><br><span class="line">		rc = _mosquitto_packet_write(mosq);</span><br><span class="line">		<span class="keyword">if</span>(rc || errno == EAGAIN || errno == COMPAT_EWOULDBLOCK)&#123;</span><br><span class="line">			<span class="keyword">return</span> _mosquitto_loop_rc_handle(mosq, rc);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行网络的写操作</li>
<li>仅仅用于不使用<strong>mosquitto_loop()</strong>，并且自己监控客户端socket时</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>max_packets</td>
<td>未使用，为了兼容性应该设置为<strong>1</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>参数无效，返回 MOSQ_ERR_INVAL<br>内存溢出，返回 MOSQ_ERR_NOMEM<br>客户端没有连接broker，返回 MOSQ_ERR_NO_CONN<br>与broker的连接失效，返回 MOSQ_ERR_CONN_LOST<br>与broker的通信中，协议错误，返回 MOSQ_ERR_PROTOCOL<br>系统调用失败，返回 MOSQ_ERR_ERRNO，可以查看详细的错误码获得错误信息</td>
</tr>
</tbody>
</table>
<h3 id="31、mosquitto_loop_misc（循环（混合））">31、mosquitto_loop_misc（循环（混合））</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_loop_misc</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">time_t</span> now;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;sock == INVALID_SOCKET) <span class="keyword">return</span> MOSQ_ERR_NO_CONN;</span><br><span class="line"></span><br><span class="line">	_mosquitto_check_keepalive(mosq);</span><br><span class="line">	now = mosquitto_time();</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;last_retry_check+<span class="number">1</span> &lt; now)&#123;</span><br><span class="line">		_mosquitto_message_retry_check(mosq);</span><br><span class="line">		mosq-&gt;last_retry_check = now;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;<span class="keyword">ping_t</span> &amp;&amp; now - mosq-&gt;<span class="keyword">ping_t</span> &gt;= mosq-&gt;keepalive)&#123;</span><br><span class="line">		<span class="comment">/* mosq-&gt;ping_t != 0 means we are waiting for a pingresp.</span><br><span class="line">		 * This hasn't happened in the keepalive time so we should disconnect.</span><br><span class="line">		 */</span></span><br><span class="line">		_mosquitto_socket_close(mosq);</span><br><span class="line">		pthread_mutex_lock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">		<span class="keyword">if</span>(mosq-&gt;state == mosq_cs_disconnecting)&#123;</span><br><span class="line">			rc = MOSQ_ERR_SUCCESS;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			rc = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pthread_mutex_unlock(&amp;mosq-&gt;state_mutex);</span><br><span class="line">		pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">		<span class="keyword">if</span>(mosq-&gt;on_disconnect)&#123;</span><br><span class="line">			mosq-&gt;in_callback = <span class="literal">true</span>;</span><br><span class="line">			mosq-&gt;on_disconnect(mosq, mosq-&gt;userdata, rc);</span><br><span class="line">			mosq-&gt;in_callback = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">		<span class="keyword">return</span> MOSQ_ERR_CONN_LOST;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行网络需要的各种各样的操作，作为network loop的一部分执行，包括处理PING和检查消息是否需要再次发送。</li>
<li>这个函数会处理<strong>PINGs</strong>，检测消息是否需要重发，所以调用很频繁</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>参数无效，返回 MOSQ_ERR_INVAL<br>客户端没有连接broker，返回 MOSQ_ERR_NO_CONN</td>
</tr>
</tbody>
</table>
<h3 id="32、mosquitto_want_write">32、mosquitto_want_write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">mosquitto_want_write</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;out_packet || mosq-&gt;current_out_packet)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_TLS</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(mosq-&gt;ssl &amp;&amp; mosq-&gt;want_write)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果有数据已经就绪，可以写入socket，返回true</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>返回值</td>
<td>如果有数据已经就绪，可以写入socket，返回true</td>
</tr>
</tbody>
</table>
<h3 id="33、mosquitto_threaded_set（在thread_mosq-c中实现）">33、mosquitto_threaded_set（在thread_mosq.c中实现）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_threaded_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">bool</span> threaded)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;threaded = threaded;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通知库使用了多线程，但不是使用<strong>mosquitto_loop_start</strong>开启的</li>
<li>如果你自己管理线程，没有是有此函数，会因为资源竞争导致crash</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>threaded</td>
<td>如果你的程序使用了多线程，设置为<strong>true</strong>，否则为<strong>false</strong></td>
</tr>
<tr>
<td>返回值</td>
<td>*</td>
</tr>
</tbody>
</table>
<h3 id="34、mosquitto_opts_set（设置参数）">34、mosquitto_opts_set（设置参数）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_opts_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">enum</span> mosq_opt_t option, <span class="keyword">void</span> *value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ival;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!mosq || !value) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(option)&#123;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_OPT_PROTOCOL_VERSION:</span><br><span class="line">			ival = *((<span class="keyword">int</span> *)value);</span><br><span class="line">			<span class="keyword">if</span>(ival == MQTT_PROTOCOL_V31)&#123;</span><br><span class="line">				mosq-&gt;protocol = mosq_p_mqtt31;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(ival == MQTT_PROTOCOL_V311)&#123;</span><br><span class="line">				mosq-&gt;protocol = mosq_p_mqtt311;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置客户端参数，必须在客户端连接前设置，</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>option</td>
<td>设置的参数。必须是int，MQTT_PROTOCOL_V31 或者 MQTT_PROTOCOL_V311<br>默认值为 MQTT_PROTOCOL_V31</td>
</tr>
<tr>
<td>value</td>
<td>option指定的值</td>
</tr>
</tbody>
</table>
<h3 id="35、mosquitto_tls_set">35、mosquitto_tls_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">int mosquitto_tls_set(struct mosquitto *mosq, const char *cafile, const char *capath, const char *certfile, const char *keyfile, int (*pw_callback)(char *buf, int size, int rwflag, void *userdata))</span><br><span class="line">&#123;</span><br><span class="line">#ifdef WITH_TLS</span><br><span class="line">	FILE *fptr;</span><br><span class="line"></span><br><span class="line">	if(!mosq || (!cafile &amp;&amp; !capath) || (certfile &amp;&amp; !keyfile) || (!certfile &amp;&amp; keyfile)) return MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	if(cafile)&#123;</span><br><span class="line">		fptr = _mosquitto_fopen(cafile, "rt");</span><br><span class="line">		if(fptr)&#123;</span><br><span class="line">			fclose(fptr);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			return MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		mosq-&gt;tls_cafile = _mosquitto_strdup(cafile);</span><br><span class="line"></span><br><span class="line">		if(!mosq-&gt;tls_cafile)&#123;</span><br><span class="line">			return MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else if(mosq-&gt;tls_cafile)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;tls_cafile);</span><br><span class="line">		mosq-&gt;tls_cafile = NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if(capath)&#123;</span><br><span class="line">		mosq-&gt;tls_capath = _mosquitto_strdup(capath);</span><br><span class="line">		if(!mosq-&gt;tls_capath)&#123;</span><br><span class="line">			return MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else if(mosq-&gt;tls_capath)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;tls_capath);</span><br><span class="line">		mosq-&gt;tls_capath = NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if(certfile)&#123;</span><br><span class="line">		fptr = _mosquitto_fopen(certfile, "rt");</span><br><span class="line">		if(fptr)&#123;</span><br><span class="line">			fclose(fptr);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			if(mosq-&gt;tls_cafile)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;tls_cafile);</span><br><span class="line">				mosq-&gt;tls_cafile = NULL;</span><br><span class="line">			&#125;</span><br><span class="line">			if(mosq-&gt;tls_capath)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;tls_capath);</span><br><span class="line">				mosq-&gt;tls_capath = NULL;</span><br><span class="line">			&#125;</span><br><span class="line">			return MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		mosq-&gt;tls_certfile = _mosquitto_strdup(certfile);</span><br><span class="line">		if(!mosq-&gt;tls_certfile)&#123;</span><br><span class="line">			return MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		if(mosq-&gt;tls_certfile) _mosquitto_free(mosq-&gt;tls_certfile);</span><br><span class="line">		mosq-&gt;tls_certfile = NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if(keyfile)&#123;</span><br><span class="line">		fptr = _mosquitto_fopen(keyfile, "rt");</span><br><span class="line">		if(fptr)&#123;</span><br><span class="line">			fclose(fptr);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			if(mosq-&gt;tls_cafile)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;tls_cafile);</span><br><span class="line">				mosq-&gt;tls_cafile = NULL;</span><br><span class="line">			&#125;</span><br><span class="line">			if(mosq-&gt;tls_capath)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;tls_capath);</span><br><span class="line">				mosq-&gt;tls_capath = NULL;</span><br><span class="line">			&#125;</span><br><span class="line">			if(mosq-&gt;tls_certfile)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;tls_certfile);</span><br><span class="line">				mosq-&gt;tls_certfile = NULL;</span><br><span class="line">			&#125;</span><br><span class="line">			return MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		mosq-&gt;tls_keyfile = _mosquitto_strdup(keyfile);</span><br><span class="line">		if(!mosq-&gt;tls_keyfile)&#123;</span><br><span class="line">			return MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		if(mosq-&gt;tls_keyfile) _mosquitto_free(mosq-&gt;tls_keyfile);</span><br><span class="line">		mosq-&gt;tls_keyfile = NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;tls_pw_callback = pw_callback;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	return MOSQ_ERR_SUCCESS;</span><br><span class="line">#else</span><br><span class="line">	return MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>待添加</li>
<li>待添加</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>cafile</td>
<td></td>
</tr>
<tr>
<td>capath</td>
<td></td>
</tr>
<tr>
<td>certfile</td>
<td></td>
</tr>
<tr>
<td>keyfile</td>
<td></td>
</tr>
</tbody>
</table>
<p>pw_callback<br>返回值|</p>
<h3 id="36、mosquitto_tls_insecure_set">36、mosquitto_tls_insecure_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_tls_insecure_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">bool</span> value)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_TLS</span></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	mosq-&gt;tls_insecure = value;</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>待添加</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>value</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="37、mosquitto_tls_opts_set">37、mosquitto_tls_opts_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_tls_opts_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">int</span> cert_reqs, <span class="keyword">const</span> <span class="keyword">char</span> *tls_version, <span class="keyword">const</span> <span class="keyword">char</span> *ciphers)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_TLS</span></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;tls_cert_reqs = cert_reqs;</span><br><span class="line">	<span class="keyword">if</span>(tls_version)&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> OPENSSL_VERSION_NUMBER &gt;= <span class="number">0x10001000</span>L</span></span><br><span class="line">		<span class="keyword">if</span>(!strcasecmp(tls_version, <span class="string">"tlsv1.2"</span>)</span><br><span class="line">				|| !strcasecmp(tls_version, <span class="string">"tlsv1.1"</span>)</span><br><span class="line">				|| !strcasecmp(tls_version, <span class="string">"tlsv1"</span>))&#123;</span><br><span class="line"></span><br><span class="line">			mosq-&gt;tls_version = _mosquitto_strdup(tls_version);</span><br><span class="line">			<span class="keyword">if</span>(!mosq-&gt;tls_version) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="keyword">if</span>(!strcasecmp(tls_version, <span class="string">"tlsv1"</span>))&#123;</span><br><span class="line">			mosq-&gt;tls_version = _mosquitto_strdup(tls_version);</span><br><span class="line">			<span class="keyword">if</span>(!mosq-&gt;tls_version) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> OPENSSL_VERSION_NUMBER &gt;= <span class="number">0x10001000</span>L</span></span><br><span class="line">		mosq-&gt;tls_version = _mosquitto_strdup(<span class="string">"tlsv1.2"</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		mosq-&gt;tls_version = _mosquitto_strdup(<span class="string">"tlsv1"</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;tls_version) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(ciphers)&#123;</span><br><span class="line">		mosq-&gt;tls_ciphers = _mosquitto_strdup(ciphers);</span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;tls_ciphers) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mosq-&gt;tls_ciphers = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>待添加</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>cert_reqs</td>
<td></td>
</tr>
<tr>
<td>tls_version</td>
<td></td>
</tr>
<tr>
<td>ciphers</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="38、mosquitto_tls_psk_set">38、mosquitto_tls_psk_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_tls_psk_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *psk, <span class="keyword">const</span> <span class="keyword">char</span> *identity, <span class="keyword">const</span> <span class="keyword">char</span> *ciphers)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> REAL_WITH_TLS_PSK</span></span><br><span class="line">	<span class="keyword">if</span>(!mosq || !psk || !identity) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check for hex only digits */</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strspn</span>(psk, <span class="string">"0123456789abcdefABCDEF"</span>) &lt; <span class="built_in">strlen</span>(psk))&#123;</span><br><span class="line">		<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	mosq-&gt;tls_psk = _mosquitto_strdup(psk);</span><br><span class="line">	<span class="keyword">if</span>(!mosq-&gt;tls_psk) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;tls_psk_identity = _mosquitto_strdup(identity);</span><br><span class="line">	<span class="keyword">if</span>(!mosq-&gt;tls_psk_identity)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;tls_psk);</span><br><span class="line">		<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(ciphers)&#123;</span><br><span class="line">		mosq-&gt;tls_ciphers = _mosquitto_strdup(ciphers);</span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;tls_ciphers) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mosq-&gt;tls_ciphers = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>待添加</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>psk</td>
<td></td>
</tr>
<tr>
<td>identity</td>
<td></td>
</tr>
<tr>
<td>ciphers</td>
<td></td>
</tr>
<tr>
<td>返回值</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="39、mosquitto_connect_callback_set">39、mosquitto_connect_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_connect_callback_set(struct mosquitto *mosq, void (*on_connect)(struct mosquitto *, void *, int))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_connect = on_connect;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置连接回调函数，当broker发送CONNACK作为连接响应时调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>on_connect</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>rc</td>
<td>连接响应的返回码<br>0 - success<br> 1 - 连接拒绝，因为版本不被接受<br> 2 - 连接拒绝，标识符拒绝<br>3 - 连接拒绝，broker不可用 <br> 4-255 保留</td>
</tr>
</tbody>
</table>
<h3 id="40、mosquitto_disconnect_callback_set">40、mosquitto_disconnect_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_disconnect_callback_set(struct mosquitto *mosq, void (*on_disconnect)(struct mosquitto *, void *, int))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_disconnect = on_disconnect;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置断开连接时的回调</li>
<li>当broker收到<strong>DISCONNECT</strong>命令，断开客户端时调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>on_disconnect</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>rc</td>
<td>整型，表明断开的原因。0，表示客户端调用 mosquitto_disconnect <br>其他数值，未知原因的断开</td>
</tr>
</tbody>
</table>
<h3 id="41、mosquitto_publish_callback_set">41、mosquitto_publish_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_publish_callback_set(struct mosquitto *mosq, void (*on_publish)(struct mosquitto *, void *, int))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_publish = on_publish;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置发布回调函数</li>
<li>当消息成功发送到broker后调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>on_publish</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>mid</td>
<td>发送消息的消息id</td>
</tr>
</tbody>
</table>
<h3 id="42、mosquitto_message_callback_set">42、mosquitto_message_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_message_callback_set(struct mosquitto *mosq, void (*on_message)(struct mosquitto *, void *, const struct mosquitto_message *))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_message = on_message;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置接收到broker消息时的回调函数</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>on_message</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>message</td>
<td>消息数据，在回调函数结束后，这个消息所绑定的内存将被释放。客户端可以根据需要拷贝消息数据</td>
</tr>
</tbody>
</table>
<h3 id="43、mosquitto_subscribe_callback_set">43、mosquitto_subscribe_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_subscribe_callback_set(struct mosquitto *mosq, void (*on_subscribe)(struct mosquitto *, void *, int, int, const int *))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_subscribe = on_subscribe;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置订阅回调。当broker对订阅要求响应时触发</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>客户端实例</td>
</tr>
<tr>
<td>on_subscribe</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>mid</td>
<td>订阅消息的消息id</td>
</tr>
<tr>
<td>qos_count</td>
<td>granted_qos的大小，准许订阅的数量</td>
</tr>
<tr>
<td>granted_qos</td>
<td>整型数组，表明每条订阅的准许的服务质量</td>
</tr>
</tbody>
</table>
<h3 id="44、mosquitto_unsubscribe_callback_set">44、mosquitto_unsubscribe_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_unsubscribe_callback_set(struct mosquitto *mosq, void (*on_unsubscribe)(struct mosquitto *, void *, int))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">	mosq-&gt;on_unsubscribe = on_unsubscribe;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置取消订阅的回调函数。当接收到broker对于取消订阅的响应时调用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>on_unsubscribe</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>mid</td>
<td>发送消息的消息id</td>
</tr>
</tbody>
</table>
<h3 id="45、mosquitto_log_callback_set">45、mosquitto_log_callback_set</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void mosquitto_log_callback_set(struct mosquitto *mosq, void (*on_log)(struct mosquitto *, void *, int, const char *))</span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;mosq-&gt;log_callback_mutex);</span><br><span class="line">	mosq-&gt;on_log = on_log;</span><br><span class="line">	pthread_mutex_unlock(&amp;mosq-&gt;log_callback_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置日志回调函数。当你需要从客户端库中获取日志消息时使用</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>on_log</td>
<td>回调函数</td>
</tr>
</tbody>
</table>
<ul>
<li>回调函数参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户数据，mosquitto_new 中提供的数据</td>
</tr>
<tr>
<td>level</td>
<td>日志级别：<br>MOSQ_LOG_INFO<br>MOSQ_LOG_NOTICE<br>MOSQ_LOG_WARNING<br>MOSQ_LOG_ERR<br>MOSQ_LOG_DEBUG</td>
</tr>
<tr>
<td>str</td>
<td>消息内容</td>
</tr>
</tbody>
</table>
<h3 id="46、mosquitto_reconnect_delay_set">46、mosquitto_reconnect_delay_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_reconnect_delay_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">unsigned</span> <span class="keyword">int</span> reconnect_delay, <span class="keyword">unsigned</span> <span class="keyword">int</span> reconnect_delay_max, <span class="keyword">bool</span> reconnect_exponential_backoff)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	</span><br><span class="line">	mosq-&gt;reconnect_delay = reconnect_delay;</span><br><span class="line">	mosq-&gt;reconnect_delay_max = reconnect_delay_max;</span><br><span class="line">	mosq-&gt;reconnect_exponential_backoff = reconnect_exponential_backoff;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当客户端在<strong>mosquitto_loop_forever</strong>中，或者调用<strong>mosquitto_loop_start</strong>后，因为未知的原因断开连接后，会尝试重新连接。默认情况下，每个1秒会尝试连接1次，直到连接成功</li>
<li>使用此函数，可以设置尝试连接的时间间隔，可以开启指数补偿来设置尝试连接的延迟以及上限值。例如，</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Example <span class="number">1</span>:</span><br><span class="line">	delay=<span class="number">2</span>, delay_max=<span class="number">10</span>, exponential_backoff=False</span><br><span class="line">	Delays would be: <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">10</span>, ...</span><br><span class="line"></span><br><span class="line">Example <span class="number">2</span>:</span><br><span class="line">	delay=<span class="number">3</span>, delay_max=<span class="number">30</span>, exponential_backoff=True</span><br><span class="line">	Delays would be: <span class="number">3</span>, <span class="number">6</span>, <span class="number">12</span>, <span class="number">24</span>, <span class="number">30</span>, <span class="number">30</span>, ...</span><br></pre></td></tr></table></figure>
<ul>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>reconnect_delay</td>
<td>重新连接的间隔时间，单位：秒</td>
</tr>
<tr>
<td>reconnect_delay_max</td>
<td>尝试连接的上限时间间隔</td>
</tr>
<tr>
<td>reconnect_exponential_backoff</td>
<td>是否开启指数补偿，<br>false，参考Example1<br>true，参考Example2</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回MOSQ_ERR_SUCCESS<br>参数无效，返回MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<h3 id="46、mosquitto_max_inflight_messages_set（在message_mosq-c中实现）">46、mosquitto_max_inflight_messages_set（在message_mosq.c中实现）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_max_inflight_messages_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">unsigned</span> <span class="keyword">int</span> max_inflight_messages)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;max_inflight_messages = max_inflight_messages;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>表示允许多大数量的QoS为1或2消息被同时进行传输处理。这些消息包括正在进行握手的消息和进行重新发送的消息。默认为20个，<br>如果设置为0，表示不设限制；如果为1，则会确保消息被顺序处理。</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>max_inflight_messages</td>
<td>最大并发数量，默认20</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br> 参数无效，返回 MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<h3 id="47、mosquitto_message_retry_set">47、mosquitto_message_retry_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mosquitto_message_retry_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">unsigned</span> <span class="keyword">int</span> message_retry)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	assert(mosq);</span><br><span class="line">	<span class="keyword">if</span>(mosq) mosq-&gt;message_retry = message_retry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>设置重复消息的时间间隔，用于QoS&gt;0的消息。可以在任何时候调用。</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>message_retry</td>
<td>等待响应的时间，默认是20秒</td>
</tr>
</tbody>
</table>
<h3 id="48、mosquitto_user_data_set">48、mosquitto_user_data_set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mosquitto_user_data_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">void</span> *userdata)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(mosq)&#123;</span><br><span class="line">		mosq-&gt;userdata = userdata;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当调用<strong>mosquitto_new</strong>时，会传递参数“obj”，这个指针将会作为用户数据传递给回调函数使用。</li>
<li>此函数可以在任何时间更新用户数据</li>
<li>此函数不会修改当前用户数据的内存，如果想要动态的分配内存，需要用户自己释放</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq</td>
<td>mosquitto实例</td>
</tr>
<tr>
<td>obj</td>
<td>用户指针，会作为参数传递给任意一个回调函数使用</td>
</tr>
</tbody>
</table>
<h3 id="49、mosquitto_socks5_set（在socks_mosq-c中实现）">49、mosquitto_socks5_set（在socks_mosq.c中实现）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_socks5_set</span><span class="params">(<span class="keyword">struct</span> mosquitto *mosq, <span class="keyword">const</span> <span class="keyword">char</span> *host, <span class="keyword">int</span> port, <span class="keyword">const</span> <span class="keyword">char</span> *username, <span class="keyword">const</span> <span class="keyword">char</span> *password)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> WITH_SOCKS</span></span><br><span class="line">	<span class="keyword">if</span>(!mosq) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">if</span>(!host || <span class="built_in">strlen</span>(host) &gt; <span class="number">256</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">	<span class="keyword">if</span>(port &lt; <span class="number">1</span> || port &gt; <span class="number">65535</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;socks5_host)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;socks5_host);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;socks5_host = _mosquitto_strdup(host);</span><br><span class="line">	<span class="keyword">if</span>(!mosq-&gt;socks5_host)&#123;</span><br><span class="line">		<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mosq-&gt;socks5_port = port;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;socks5_username)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;socks5_username);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(mosq-&gt;socks5_password)&#123;</span><br><span class="line">		_mosquitto_free(mosq-&gt;socks5_password);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(username)&#123;</span><br><span class="line">		mosq-&gt;socks5_username = _mosquitto_strdup(username);</span><br><span class="line">		<span class="keyword">if</span>(!mosq-&gt;socks5_username)&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(password)&#123;</span><br><span class="line">			mosq-&gt;socks5_password = _mosquitto_strdup(password);</span><br><span class="line">			<span class="keyword">if</span>(!mosq-&gt;socks5_password)&#123;</span><br><span class="line">				_mosquitto_free(mosq-&gt;socks5_username);</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_NOT_SUPPORTED;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>待添加</li>
</ul>
<h3 id="50、mosquitto_strerror">50、mosquitto_strerror</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mosquitto_strerror</span><span class="params">(<span class="keyword">int</span> mosq_errno)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(mosq_errno)&#123;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_CONN_PENDING:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection pending."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_SUCCESS:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"No error."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_NOMEM:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Out of memory."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_PROTOCOL:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"A network protocol error occurred when communicating with the broker."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_INVAL:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Invalid function arguments provided."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_NO_CONN:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"The client is not currently connected."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_CONN_REFUSED:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"The connection was refused."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_NOT_FOUND:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Message not found (internal error)."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_CONN_LOST:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"The connection was lost."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_TLS:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"A TLS error occurred."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_PAYLOAD_SIZE:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Payload too large."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_NOT_SUPPORTED:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"This feature is not supported."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_AUTH:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Authorisation failed."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_ACL_DENIED:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Access denied by ACL."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_UNKNOWN:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Unknown error."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_ERRNO:</span><br><span class="line">			<span class="keyword">return</span> strerror(errno);</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_EAI:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Lookup error."</span>;</span><br><span class="line">		<span class="keyword">case</span> MOSQ_ERR_PROXY:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Proxy error."</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Unknown error."</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取mosquitto错误码</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>mosq_errno</td>
<td>mosquitto错误码</td>
</tr>
<tr>
<td>返回值</td>
<td>描述错误的字符串</td>
</tr>
</tbody>
</table>
<h3 id="51、mosquitto_connack_string">51、mosquitto_connack_string</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mosquitto_connack_string</span><span class="params">(<span class="keyword">int</span> connack_code)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(connack_code)&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Accepted."</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: unacceptable protocol version."</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: identifier rejected."</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: broker unavailable."</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: bad user name or password."</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: not authorised."</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"Connection Refused: unknown reason."</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取描述MQTT连接结果的字符串</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>connack_code</td>
<td>MQTT连接结果</td>
</tr>
<tr>
<td>返回值</td>
<td>描述结果的字符串</td>
</tr>
</tbody>
</table>
<h3 id="52、mosquitto_sub_topic_tokenise">52、mosquitto_sub_topic_tokenise</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_sub_topic_tokenise</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *subtopic, <span class="keyword">char</span> ***topics, <span class="keyword">int</span> *count)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">int</span> hier_count = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> start, stop;</span><br><span class="line">	<span class="keyword">int</span> hier;</span><br><span class="line">	<span class="keyword">int</span> tlen;</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!subtopic || !topics || !count) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	len = <span class="built_in">strlen</span>(subtopic);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(subtopic[i] == <span class="string">'/'</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(i &gt; len-<span class="number">1</span>)&#123;</span><br><span class="line">				<span class="comment">/* Separator at end of line */</span></span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				hier_count++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	(*topics) = _mosquitto_calloc(hier_count, <span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</span><br><span class="line">	<span class="keyword">if</span>(!(*topics)) <span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line"></span><br><span class="line">	start = <span class="number">0</span>;</span><br><span class="line">	stop = <span class="number">0</span>;</span><br><span class="line">	hier = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len+<span class="number">1</span>; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(subtopic[i] == <span class="string">'/'</span> || subtopic[i] == <span class="string">'\0'</span>)&#123;</span><br><span class="line">			stop = i;</span><br><span class="line">			<span class="keyword">if</span>(start != stop)&#123;</span><br><span class="line">				tlen = stop-start + <span class="number">1</span>;</span><br><span class="line">				(*topics)[hier] = _mosquitto_calloc(tlen, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">				<span class="keyword">if</span>(!(*topics)[hier])&#123;</span><br><span class="line">					<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;hier_count; i++)&#123;</span><br><span class="line">						<span class="keyword">if</span>((*topics)[hier])&#123;</span><br><span class="line">							_mosquitto_free((*topics)[hier]);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					_mosquitto_free((*topics));</span><br><span class="line">					<span class="keyword">return</span> MOSQ_ERR_NOMEM;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">for</span>(j=start; j&lt;stop; j++)&#123;</span><br><span class="line">					(*topics)[hier][j-start] = subtopic[j];</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			start = i+<span class="number">1</span>;</span><br><span class="line">			hier++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*count = hier_count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>将topic或者订阅字符串放入数组中来表示层级</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>subtopic</td>
<td>要分级的subscription/topic</td>
</tr>
<tr>
<td>topics</td>
<td>字符串数组，用来保存每一级的内容</td>
</tr>
<tr>
<td>count</td>
<td>保存级别数量</td>
</tr>
</tbody>
</table>
<p>例如，<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">For</span> example:</span><br><span class="line"></span><br><span class="line"> subtopic: <span class="string">"a/deep/topic/hierarchy"</span></span><br><span class="line">   <span class="type">Would</span> <span class="literal">result</span> <span class="keyword">in</span>:</span><br><span class="line">   topics[<span class="number">0</span>] = <span class="string">"a"</span></span><br><span class="line">   topics[<span class="number">1</span>] = <span class="string">"deep"</span></span><br><span class="line">   topics[<span class="number">2</span>] = <span class="string">"topic"</span></span><br><span class="line">   topics[<span class="number">3</span>] = <span class="string">"hierarchy"</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">and</span>:</span><br><span class="line"> </span><br><span class="line">  subtopic: <span class="string">"/a/deep/topic/hierarchy/"</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">Would</span> <span class="literal">result</span> <span class="keyword">in</span>:</span><br><span class="line"> </span><br><span class="line">  topics[<span class="number">0</span>] = <span class="type">NULL</span></span><br><span class="line">  topics[<span class="number">1</span>] = <span class="string">"a"</span></span><br><span class="line">  topics[<span class="number">2</span>] = <span class="string">"deep"</span></span><br><span class="line">  topics[<span class="number">3</span>] = <span class="string">"topic"</span></span><br><span class="line">  topics[<span class="number">4</span>] = <span class="string">"hierarchy"</span></span><br><span class="line"> </span><br><span class="line">  <span class="type">Parameters</span>:</span><br><span class="line"> 	subtopic - the subscription/topic to tokenise</span><br><span class="line"> 	topics -   a <span class="type">pointer</span> to store the <span class="type">array</span> <span class="keyword">of</span> strings</span><br><span class="line"> 	count -    an <span class="type">int</span> <span class="type">pointer</span> to store the number <span class="keyword">of</span> items <span class="keyword">in</span> the topics <span class="type">array</span>.</span><br><span class="line"> </span><br><span class="line">  <span class="type">Returns</span>:</span><br><span class="line"> 	<span class="type">MOSQ_ERR_SUCCESS</span> - on success</span><br><span class="line">  	<span class="type">MOSQ_ERR_NOMEM</span> -   <span class="keyword">if</span> an <span class="keyword">out</span> <span class="keyword">of</span> memory condition occurred.</span><br><span class="line">  <span class="type">Example</span>:</span><br><span class="line"> </span><br><span class="line">  &gt; <span class="type">char</span> **topics;</span><br><span class="line">  &gt; <span class="type">int</span> topic_count;</span><br><span class="line">  &gt; <span class="type">int</span> i;</span><br><span class="line">  &gt; </span><br><span class="line">  &gt; mosquitto_sub_topic_tokenise(<span class="string">"$SYS/broker/uptime"</span>, &amp;topics, &amp;topic_count);</span><br><span class="line">  &gt;</span><br><span class="line">  &gt; <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;token_count; i++)&#123;</span><br><span class="line">  &gt;     printf(<span class="string">"%d: %s\n"</span>, i, topics[i]);</span><br><span class="line">  &gt; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="53、mosquitto_sub_topic_tokens_free">53、mosquitto_sub_topic_tokens_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_sub_topic_tokens_free</span><span class="params">(<span class="keyword">char</span> ***topics, <span class="keyword">int</span> count)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!topics || !(*topics) || count&lt;<span class="number">1</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;count; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>((*topics)[i]) _mosquitto_free((*topics)[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	_mosquitto_free(*topics);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>释放<strong>mosquitto_sub_topic_tokenise</strong>分配的内存</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>topics</td>
<td>字符串数组</td>
</tr>
<tr>
<td>count</td>
<td>字符串数组中元素个数</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>参数无效，返回 MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<h3 id="54、mosquitto_topic_matches_sub（在util_mosq-c中实现）">54、mosquitto_topic_matches_sub（在util_mosq.c中实现）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_topic_matches_sub</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *sub, <span class="keyword">const</span> <span class="keyword">char</span> *topic, <span class="keyword">bool</span> *result)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> slen, tlen;</span><br><span class="line">	<span class="keyword">int</span> spos, tpos;</span><br><span class="line">	<span class="keyword">bool</span> multilevel_wildcard = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!sub || !topic || !result) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	slen = <span class="built_in">strlen</span>(sub);</span><br><span class="line">	tlen = <span class="built_in">strlen</span>(topic);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(slen &amp;&amp; tlen)&#123;</span><br><span class="line">		<span class="keyword">if</span>((sub[<span class="number">0</span>] == <span class="string">'$'</span> &amp;&amp; topic[<span class="number">0</span>] != <span class="string">'$'</span>)</span><br><span class="line">				|| (topic[<span class="number">0</span>] == <span class="string">'$'</span> &amp;&amp; sub[<span class="number">0</span>] != <span class="string">'$'</span>))&#123;</span><br><span class="line"></span><br><span class="line">			*result = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spos = <span class="number">0</span>;</span><br><span class="line">	tpos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(spos &lt; slen &amp;&amp; tpos &lt; tlen)&#123;</span><br><span class="line">		<span class="keyword">if</span>(sub[spos] == topic[tpos])&#123;</span><br><span class="line">			<span class="keyword">if</span>(tpos == tlen-<span class="number">1</span>)&#123;</span><br><span class="line">				<span class="comment">/* Check for e.g. foo matching foo/# */</span></span><br><span class="line">				<span class="keyword">if</span>(spos == slen-<span class="number">3</span> </span><br><span class="line">						&amp;&amp; sub[spos+<span class="number">1</span>] == <span class="string">'/'</span></span><br><span class="line">						&amp;&amp; sub[spos+<span class="number">2</span>] == <span class="string">'#'</span>)&#123;</span><br><span class="line">					*result = <span class="literal">true</span>;</span><br><span class="line">					multilevel_wildcard = <span class="literal">true</span>;</span><br><span class="line">					<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			spos++;</span><br><span class="line">			tpos++;</span><br><span class="line">			<span class="keyword">if</span>(spos == slen &amp;&amp; tpos == tlen)&#123;</span><br><span class="line">				*result = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(tpos == tlen &amp;&amp; spos == slen-<span class="number">1</span> &amp;&amp; sub[spos] == <span class="string">'+'</span>)&#123;</span><br><span class="line">				spos++;</span><br><span class="line">				*result = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(sub[spos] == <span class="string">'+'</span>)&#123;</span><br><span class="line">				spos++;</span><br><span class="line">				<span class="keyword">while</span>(tpos &lt; tlen &amp;&amp; topic[tpos] != <span class="string">'/'</span>)&#123;</span><br><span class="line">					tpos++;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(tpos == tlen &amp;&amp; spos == slen)&#123;</span><br><span class="line">					*result = <span class="literal">true</span>;</span><br><span class="line">					<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(sub[spos] == <span class="string">'#'</span>)&#123;</span><br><span class="line">				multilevel_wildcard = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">if</span>(spos+<span class="number">1</span> != slen)&#123;</span><br><span class="line">					*result = <span class="literal">false</span>;</span><br><span class="line">					<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					*result = <span class="literal">true</span>;</span><br><span class="line">					<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				*result = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(multilevel_wildcard == <span class="literal">false</span> &amp;&amp; (tpos &lt; tlen || spos &lt; slen))&#123;</span><br><span class="line">		*result = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测topic是否和订阅匹配</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>sub</td>
<td>订阅字符串，用于和topic比对</td>
</tr>
<tr>
<td>topic</td>
<td>检测的topic</td>
</tr>
<tr>
<td>result</td>
<td>true，如果匹配</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>参数无效，返回 MOSQ_ERR_INVAL<br>内存溢出，返回 MOSQ_ERR_NOMEM</td>
</tr>
</tbody>
</table>
<p>例如，<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">foo</span>/<span class="keyword">bar </span>would match the <span class="keyword">subscription </span>foo/# or +/<span class="keyword">bar</span><br><span class="line"></span><span class="label">non</span>/matching would not match the <span class="keyword">subscription </span>non/+/+</span><br></pre></td></tr></table></figure></p>
<h3 id="55、mosquitto_pub_topic_check（在util_mosq-c中实现）">55、mosquitto_pub_topic_check（在util_mosq.c中实现）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_pub_topic_check</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(str &amp;&amp; str[<span class="number">0</span>])&#123;</span><br><span class="line">		<span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">'+'</span> || str[<span class="number">0</span>] == <span class="string">'#'</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		len++;</span><br><span class="line">		str = &amp;str[<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(len &gt; <span class="number">65535</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测要发布的topic是否有效</li>
<li>会检测‘+’和‘#’，检测长度</li>
<li>在<strong>mosquitto_publish</strong>和<strong>mosquitto_will_set</strong>已经执行了此方法，不需要在它们之前直接调用此方法</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>topic</td>
<td>需要检测的topic</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>如果包含’+’或者’#’，或者长度过大，返回 MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<h3 id="56、mosquitto_sub_topic_check">56、mosquitto_sub_topic_check</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mosquitto_sub_topic_check</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> c = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(str &amp;&amp; str[<span class="number">0</span>])&#123;</span><br><span class="line">		<span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">'+'</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>((c != <span class="string">'\0'</span> &amp;&amp; c != <span class="string">'/'</span>) || (str[<span class="number">1</span>] != <span class="string">'\0'</span> &amp;&amp; str[<span class="number">1</span>] != <span class="string">'/'</span>))&#123;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">'#'</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>((c != <span class="string">'\0'</span> &amp;&amp; c != <span class="string">'/'</span>)  || str[<span class="number">1</span>] != <span class="string">'\0'</span>)&#123;</span><br><span class="line">				<span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		len++;</span><br><span class="line">		c = str[<span class="number">0</span>];</span><br><span class="line">		str = &amp;str[<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(len &gt; <span class="number">65535</span>) <span class="keyword">return</span> MOSQ_ERR_INVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MOSQ_ERR_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测一个订阅是否有效</li>
<li>会检测‘+’和‘#’，检测它们是否在有效的位置，检测长度,例如</li>
</ul>
<p><code>foo/#/bar, foo/+bar or foo/bar#</code></p>
<ul>
<li>在<strong>mosquitto_subscribe</strong>和<strong>mosquitto_unsubscribe</strong>中已经调用，不需要在它们之前直接调用此方法</li>
<li>参数说明</li>
</ul>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td>要检测的订阅</td>
</tr>
<tr>
<td>返回值</td>
<td>成功，返回 MOSQ_ERR_SUCCESS<br>如果包含’+’或者’#’，或者长度过大，返回 MOSQ_ERR_INVAL</td>
</tr>
</tbody>
</table>
<hr>
<p>(That’s all)</p>

  </section>

  
  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    
    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
